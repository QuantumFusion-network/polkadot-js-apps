name: Cleanup Preview Deployments

on:
  pull_request:
    types: [closed]
    branches:
      - 'qf-master-test'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    name: Remove Preview Deployment
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    env:
      CLOUDFLARE_SUBDOMAIN: 'seva-dbd'  # Your Cloudflare Workers subdomain

    steps:
      - name: ๐งน Cleanup Info
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐งน PREVIEW CLEANUP STARTED"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ Event: PR closed"
          echo "๐ฏ PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "๐ฟ Branch: ${{ github.head_ref }}"
          echo "๐ค Closed by: ${{ github.event.pull_request.closed_by.login }}"
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "โ Status: Merged"
          else
            echo "โ Status: Closed without merge"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ง Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: ๐ฆ Install dependencies
        run: |
          echo "๐ฆ Installing dependencies (needed for wrangler)..."
          yarn install --frozen-lockfile
          echo "โ Dependencies installed"

      - name: ๐ท๏ธ Generate worker name to delete
        id: branch-name
        run: |
          echo "๐ท๏ธ Generating worker name from branch..."
          
          branch_name="${{ github.head_ref }}"
          echo "๐ Original branch name: $branch_name"
          
          # Sanitize branch name (same logic as deploy workflow)
          sanitized_branch=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          sanitized_branch=$(echo "$sanitized_branch" | cut -c1-50)
          sanitized_branch=$(echo "$sanitized_branch" | sed 's/-$//')
          
          worker_name="portal-worker-test-preview-$sanitized_branch"
          
          echo "worker_name=$worker_name" >> $GITHUB_OUTPUT
          echo "branch_name=$sanitized_branch" >> $GITHUB_OUTPUT
          
          echo "โ Worker name to delete: $worker_name"
          echo "๐ URL that will be removed: https://$worker_name.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev"

      - name: ๐ Copy Wrangler config
        run: |
          echo "๐ Preparing wrangler configuration..."
          cp wrangler.toml packages/apps/build/ || echo "โ๏ธ  Build directory doesn't exist (this is OK for cleanup)"
          echo "โ Configuration ready"

      - name: ๐๏ธ Delete preview deployment
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: delete --name ${{ steps.branch-name.outputs.worker_name }}
        continue-on-error: true

      - name: ๐ฌ Comment on PR about cleanup
        if: github.event.pull_request != null
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const workerName = "${{ steps.branch-name.outputs.worker_name }}"
              const branchName = "${{ github.head_ref }}"
              const wasPreviewUrl = `https://${workerName}.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev`
              const wasMerged = "${{ github.event.pull_request.merged }}" === "true"
              
              console.log('๐งน Adding cleanup comment to PR...')
              
              let statusEmoji = wasMerged ? 'โ' : 'โ'
              let statusText = wasMerged ? 'merged' : 'closed'
              
              let productionSection = ''
              if (wasMerged) {
                const productionUrl = `https://portal-worker-test-production.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev`
                productionSection = `\n\n๐ฆ **Production deployment is now available at:**\n   ${productionUrl}`
              }
              
              const cleanupBody = `๐งน **Preview Deployment Cleaned Up**

              ${statusEmoji} **PR Status**: ${statusText}
              ๐๏ธ  **Worker Deleted**: \`${workerName}\`
              ๐ฟ **Branch**: \`${branchName}\`
              ๐ **Removed URL**: ~~${wasPreviewUrl}~~
              ๐ **Status**: Preview deployment removed successfully${productionSection}
              
              > The preview deployment has been automatically cleaned up since this PR was ${statusText}.`
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: cleanupBody
              })
              
              console.log('โ Comment posted successfully')
            } catch (error) {
              console.error('โ Error commenting on PR:', error)
              core.warning('Failed to comment on PR: ' + error.message)
            }

      - name: ๐ Cleanup Success
        if: success()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ CLEANUP COMPLETED SUCCESSFULLY!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Worker deleted: ${{ steps.branch-name.outputs.worker_name }}"
          echo "๐ฟ Branch: ${{ github.head_ref }}"
          echo "๐ Removed URL: https://${{ steps.branch-name.outputs.worker_name }}.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev"
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "๐ฆ Production deployment is now available at:"
            echo "   https://portal-worker-test-production.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐จ Cleanup Failure
        if: failure()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐จ CLEANUP FAILED!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ๏ธ  This might be OK if:"
          echo "   - Worker was already deleted manually"
          echo "   - Worker never existed (no preview was deployed)"
          echo "โ Check the logs above for details"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โน๏ธ  Note: Cleanup failure won't block PR merge"

