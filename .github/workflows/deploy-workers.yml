name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - 'qf-master'  # Production deployment on merge
  pull_request:
    branches:
      - 'qf-master'  # Preview deployment for PRs

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ${{ github.event_name == 'pull_request' && 'Deploy Preview' || 'Deploy Production' }}
    permissions:
      contents: read
      deployments: write
      issues: write
      pull-requests: write
    
    env:
      CLOUDFLARE_SUBDOMAIN: 'seva-dbd'  # Your Cloudflare Workers subdomain

    steps:
      - name: ğŸ“‹ Deployment Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ CLOUDFLARE DEPLOYMENT STARTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Event: ${{ github.event_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ”— Repo: ${{ github.repository }}"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ¯ PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
            echo "ğŸŒ¿ Head branch: ${{ github.head_ref }}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ—ï¸ Build project
        run: |
          echo "ğŸ—ï¸ Building project..."
          yarn build:www
          echo "âœ… Build completed successfully"

      - name: ğŸ” Verify build output
        run: |
          echo "ğŸ” Verifying build output..."
          if [ ! -d "./packages/apps/build" ]; then
            echo "ğŸš¨ Build failed: packages/apps/build directory not found"
            exit 1
          fi
          echo "âœ… Build directory exists"
          echo "ğŸ“Š Build size: $(du -sh ./packages/apps/build | cut -f1)"
          echo "ğŸ“ Build contents:"
          ls -lh ./packages/apps/build | head -10

      - name: ğŸ·ï¸ Generate branch-based worker name (Preview)
        if: github.event_name == 'pull_request'
        id: branch-name
        run: |
          echo "ğŸ·ï¸ Generating worker name for preview deployment..."
          
          branch_name="${{ github.head_ref }}"
          echo "ğŸ“ Original branch name: $branch_name"
          
          # Sanitize branch name for Cloudflare Workers
          sanitized_branch=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          sanitized_branch=$(echo "$sanitized_branch" | cut -c1-50)
          sanitized_branch=$(echo "$sanitized_branch" | sed 's/-$//')
          
          worker_name="portal-worker-preview-$sanitized_branch"
          
          echo "worker_name=$worker_name" >> $GITHUB_OUTPUT
          echo "branch_name=$sanitized_branch" >> $GITHUB_OUTPUT
          
          echo "âœ… Worker name generated: $worker_name"

      - name: ğŸš€ Deploy to Cloudflare Workers (Preview)
        if: github.event_name == 'pull_request'
        id: deploy-preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name ${{ steps.branch-name.outputs.worker_name }}

      - name: ğŸš€ Deploy to Cloudflare Workers (Production)
        if: github.ref == 'refs/heads/qf-master' && github.event_name == 'push'
        id: deploy-production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env production

      - name: ğŸ”— Extract preview URL
        if: github.event_name == 'pull_request'
        id: extract-url
        run: |
          echo "ğŸ”— Generating preview URL..."
          preview_url="https://${{ steps.branch-name.outputs.worker_name }}.${{ env.CLOUDFLARE_SUBDOMAIN }}.workers.dev"
          echo "preview_url=$preview_url" >> $GITHUB_OUTPUT
          echo "âœ… Preview URL: $preview_url"

      - name: ğŸ’¬ Comment PR with preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const previewUrl = "${{ steps.extract-url.outputs.preview_url }}"
              const commitSha = context.payload.pull_request.head.sha.substring(0, 7)
              
              console.log('ğŸ” PR number:', context.payload.pull_request?.number)
              
              const prNumber = context.payload.pull_request?.number || context.issue?.number
              
              if (!prNumber) {
                console.log('âš ï¸  No PR/issue number found, skipping comment')
                return
              }
              
              // Find existing deployment comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              })
              
              const existingComment = comments.find(comment =>
                comment.body.includes('ğŸš€ **Deploy Preview')
              )
              
              const branchName = "${{ github.head_ref }}"
              const workerName = "${{ steps.branch-name.outputs.worker_name }}"
              
              const commentBody = `ğŸš€ **Deploy Preview Ready!**

              âœ… **Preview**: ${previewUrl}
              ğŸ“¦ **Built from**: \`${commitSha}\`
              ğŸŒ¿ **Branch**: \`${branchName}\`
              âš™ï¸  **Worker**: \`${workerName}\`
              ğŸ”„ **Status**: Deployed successfully
              
              > This preview will be updated automatically when you push new commits to this PR.
              > Preview will be cleaned up automatically when PR is closed.`
              
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody
                })
                console.log('âœ… Updated existing comment')
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                })
                console.log('âœ… Created new comment')
              }
            } catch (error) {
              console.error('âŒ Error commenting on PR:', error)
              core.warning('Failed to comment on PR: ' + error.message)
            }

      - name: ğŸ‰ Deployment Success (Preview)
        if: success() && github.event_name == 'pull_request'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ PREVIEW DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Preview URL: ${{ steps.extract-url.outputs.preview_url }}"
          echo "ğŸŒ¿ Branch: ${{ github.head_ref }}"
          echo "âš™ï¸  Worker: ${{ steps.branch-name.outputs.worker_name }}"
          echo "ğŸ“¦ Commit: ${{ github.event.pull_request.head.sha }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ‰ Deployment Success (Production)
        if: success() && github.event_name == 'push'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Production URL: https://portal.qfnetwork.xyz"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸš¨ Deployment Failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ DEPLOYMENT FAILED!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Check the logs above for details"
          echo "ğŸ” Common issues:"
          echo "  - Build directory not found"
          echo "  - Wrangler authentication failed"
          echo "  - Invalid configuration"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
